name: CD

on:
  push:
    branches: [ main ]

jobs:
  deploy:
    runs-on: self-hosted   # your WSL runner

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Docker info
        run: |
          docker version
          docker compose version

      # üîπ Create root .env
      - name: Create root .env
        run: |
          cat << 'EOF' > .env
          POSTGRES_DB=gym_management
          POSTGRES_USER=postgres
          POSTGRES_PASSWORD=password
          EOF

      # üîπ Create backend/.env
      - name: Create backend .env
        run: |
          mkdir -p backend
          cat << 'EOF' > backend/.env
          NODE_ENV=production
          PORT=3000
          DATABASE_URL=postgresql://postgres:password@postgres:5432/gym_management
          FRONTEND_URL=http://localhost
          EOF

      # üîπ Create frontend/.env
      - name: Create frontend .env
        run: |
          mkdir -p frontend
          cat << 'EOF' > frontend/.env
          VITE_API_URL=http://localhost/api
          EOF

      # üîπ Create shared network
      - name: Create shared network if missing
        run: |
          docker network inspect gateway_net >/dev/null 2>&1 || docker network create gateway_net

      # ‚ö†Ô∏è CLEANUP STEP (Fixes "Port 80 already allocated")
      # This stops Traefik from TP1 and removes any old containers hanging around
      - name: Cleanup Old Stack
        run: |
          # Stop the old compose stack if the file exists
          if [ -f docker-compose.yaml ]; then
            docker compose -f docker-compose.yaml down --remove-orphans || true
          fi
          
          # Force stop specific containers that might hog ports
          docker stop traefik nginx-router || true
          docker rm traefik nginx-router || true

      # üîπ Deploy Blue Stack
      - name: Deploy Blue Stack
        run: |
          docker compose -f docker-compose.blue.yml pull
          docker compose -f docker-compose.blue.yml up -d --build

      # üîπ Deploy Nginx Endpoint
      - name: Start Nginx Endpoint
        run: |
          docker compose -f docker-compose.endpoint.yml up -d --build

      # üîπ Prune unused images
      - name: Prune Docker System
        run: docker system prune -f